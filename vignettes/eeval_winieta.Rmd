---
title: "Opis pakietu `eeval`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Opis pakietu `eeval`}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  comment = "#>", 
  echo = T, 
  message = F, 
  warning = F
)
```

```{r setup1, include=FALSE, results='hide'}
# By nie pobierać w kółko danych do kompilacji
library(eeval)
getwd()
# load(file = "../R/sysdata.rda")
```


**Jakub Rudek**
Geoinformacja III rok

**e-mail:** *[rjakub999@gmail.com](rjakub999@gmail.com)*

***
## Wstęp
***

Pakiet utworzony w ramach przedmiotu Inwentaryzacja i Szacowanie Emisji.  
Służy do obliczania emisji zanieczyszczeń generowanych przez pojazdy z silnikami spalinowymi i wyświetlania wyników na wykresach. Funkcje pakietu korzystają z danych dołączonych do pakietu.   
Plik źródłowy z surowymi danymi:  `1.A.3.b.i-iv Road Transport Appendix 4 Emission Factors 2019.xlsx` nie znajduje się w pakiecie. Został on wstępnie przetworzony i zpisany jako ramka danych `wskazniki`. Ten obiekt jest dołączony do pakietu i stanowi podstawowe dane do dalszych analiz. Do prawiłdowego działania funkcji pakietu nie można zmieniać formatu daych zawartych w obiekcie `wskazniki`.

Winieta opisuje nastpujące zagadnienia:  
1. Zawartość **surowego pliku danych** `1.A.3.b.i-iv Road Transport Appendix 4 Emission Factors 2019.xlsx`
   i ewentualne samodzielne przygotowanie danych wejściowych dla funkcji pakietu.
2. Format **danych wejściowych** przetwarzanych przez funkcje pakietu.  
3. Opis **funkcji pakietu** i możliwości ich wykorzystania.  


***
## Instalacja pakietu
***

Repozytorium pakietu znajduje się na portalu [github](https://github.com/).
Do jego pobrania i instalacji potrzebny jest pakiet `devtools`.

```{r setup2, eval=FALSE}
if(!require(devtools)) {install.packages("devtools"); require(devtools)}
# instalcja pakietu eeval
devtools::install_github("rjakub999/eeval")
library(eeval)
```

Wszystkie funkcje i dane zawarte w pakiecie posiadają dokumentację dostępną w systemie pomocy programu RStudio.
Poniżej sposób wywołania ogólnych informacji o pakiecie.

```{r, eval=F}
help(package = "eeval")
```

Do pełnego wykorzystania możliwości pakietu zalecane jest załadowanie dodatkowych pakietów.

```{r, results='hide'}
library(dplyr)
library(magrittr)
library(qpdf)
library(utils)
library(rlang)
library(stats)
library(ggplot2)
```

***
## 1. Surowy plik danych
***

Plik z surowymi danymi `1.A.3.b.i-iv Road Transport Appendix 4 Emission Factors 2019.xlsx`

Można też pobrać aktualną wersję pliku surowych danych ze strony:
[eea dane](https://www.eea.europa.eu/publications/emep-eea-guidebook-2019/part-b-sectoral-guidance-chapters/1-energy/1-a-combustion/road-transport-appendix-4-emission/view)

Dokumemntacja do tych danych jest zamieszczona na stronie:
[eea pdf](https://www.eea.europa.eu/publications/emep-eea-guidebook-2019/part-b-sectoral-guidance-chapters/1-energy/1-a-combustion/1-a-3-b-i/view)

Następnie można samodzielnie utworzyć obiekt `wskazniki`. W tym celu należy użyć następującego kodu:

``` {r utworz_wskazn, eval = FALSE}
library("openxlsx")
katalog = "c:/sciezka_do_pliku/"
setwd(katalog)
plik_xlsx = "1.A.3.b.i-iv Road Transport Appendix 4 Emission Factors 2019.xlsx"
wskazniki <- openxlsx::read.xlsx(xlsxFile = plik_xlsx, sheet = 2)

wskazniki$Mode[is.na(wskazniki$Mode)] <- ""

wskazniki <-wskazniki %>% 
  select(-`EF.[g/km].or.ECF.[MJ/km]`,
         -`Min.Speed.[km/h]`,
         -`Max.Speed.[km/h]`,
         -`Road.Slope`,
         -`Load`)

colnames(wskazniki)[15:17] <- c("Reduction", "Bio", "Procent")
```

***
## 2. Dane wejściowe 
***

Obiekt `input` to dane wejsciowe dla funkcji szacowania emisji.
Zawiera następujące dane:  
* Natężenie ruchu to wygenerowany losowo wektor o zadanej długosci.  
* Pozostale dane są wybrane z obiektu wskazniki.  



***
## 3. Funkcje pakietu 
***

```
## ZESTAW PARAMETROW DOMYSLNYCH -----------------------------------
eeval_calc()
eeval_draw()

## ZESTAW PARAMETROW nr 2 ------------------------------------------
# losowanie danych
input2 <- eeval_input(segm = c("Mini","Small","Medium","Large-SUV-Executive"),
                      n_spl = 300)

# obliczenia emisji 
eeval_wynik2 <- 
  eeval_calc(dane = input2,
             kategoria = "Passenger Cars",
             euro = c("Euro 3", "Euro 4", "Euro 5", "Euro 6 up to 2016"),
             substancja = c("EC", "CO", "NOx"),
             mode = "")

# rysowanie wykresu
eeval_draw(dane = eeval_wynik2,
           x = .data$Nat,
           y = .data$Emisja,
           z = .data$Pollutant,
           u = .data$Euro.Standard,
           nrow = 2,
           max_y = 2000)


## ZESTAW PARAMETROW nr 3 ----------------------------------------------
wskazniki %>% 
  filter(Category == "Buses") %>% 
  select(Segment) %>% 
  unique()

# Jezeli input3 z wektorem segm., ktory nie nalezy do 
# danej kategorii pojazdow to zglosi nam blad -
# przedostatnia linijka eeval_calc()

# losowanie danych
input3 <- eeval_input(segm = c("Urban Buses Midi <=15 t",
                               "Urban Buses Standard 15 - 18 t",
                               "Urban Buses Articulated >18 t",
                               "Coaches Standard <=18 t"),
                      n_spl = 200)

# obliczenia emisji
eeval_wynik3 <- 
  eeval_calc(dane = input3,
             kategoria = "Buses",
             euro = c("Euro II", "Euro III", "Euro IV", "Euro V"),
             substancja = c("EC", "CO", "NOx", "NH3"),
             mode = "")

# rysowanie wykresow
eeval_draw(dane = eeval_wynik3,
           x = .data$Segment,
           y = .data$Emisja,
           z = .data$Pollutant,
           nrow = 2,
           max_y = 1000)
```
